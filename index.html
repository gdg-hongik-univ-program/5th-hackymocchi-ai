<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HackyMocchi - Autonomous Pentest Agent</title>
<style>
/* ── Reset + Variables ───────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

:root{
  --bg:#0f1117; --bg-card:#171921; --bg-input:#1e2028;
  --bg-hover:#22252e;
  --border:#2d303a; --border-hover:#3e4250;
  --text:#e8e8ec; --text-muted:#b0b4c0; --text-dim:#7d8290;
  --accent:#4b8df8; --accent-hover:#3572d9;
  --green:#2dd268; --green-bg:rgba(45,210,104,.1);
  --yellow:#f0b816; --yellow-bg:rgba(240,184,22,.1);
  --red:#f05252; --red-bg:rgba(240,82,82,.1);
  --font-mono:'SF Mono','Cascadia Code','Fira Code','Consolas',monospace;
  --font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',sans-serif;
  --radius:8px; --radius-lg:12px;
  --shadow-card:0 1px 3px rgba(0,0,0,.25);
  --shadow-tooltip:0 8px 32px rgba(0,0,0,.45);
  --fw-normal:470; --fw-medium:540; --fw-semi:640; --fw-bold:740;
}

[data-theme="light"]{
  --bg:#f5f6f8; --bg-card:#ffffff; --bg-input:#eef0f4;
  --bg-hover:#e8eaef;
  --border:#d4d7de; --border-hover:#bcc0c9;
  --text:#1a1d26; --text-muted:#3d4252; --text-dim:#6b7080;
  --green:#178a42; --green-bg:rgba(23,138,66,.08);
  --shadow-card:0 1px 4px rgba(0,0,0,.08);
  --shadow-tooltip:0 8px 32px rgba(0,0,0,.14);
}

body{
  font-family:var(--font-sans); background:var(--bg); color:var(--text);
  font-size:16px; line-height:1.65; min-height:100vh;
  font-weight:var(--fw-normal);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
a{color:var(--accent);text-decoration:none;}
a:hover{text-decoration:underline;}

/* ── Layout ──────────────────────────────────────────────────────── */
.container{max-width:900px;margin:0 auto;padding:28px 24px 48px;}

/* ── Header ──────────────────────────────────────────────────────── */
.header{text-align:center;padding:36px 0 28px;position:relative;}
.header-title{
  font-size:2.6rem;font-weight:var(--fw-bold);letter-spacing:2px;
  position:relative;display:inline-block;
}
.header-subtitle{
  font-size:0.82rem;color:var(--text-dim);text-transform:uppercase;
  letter-spacing:2px;margin-top:6px;font-weight:var(--fw-semi);
}

.theme-btn{
  position:absolute;right:0;top:50%;transform:translateY(-50%);
  width:40px;height:34px;display:flex;align-items:center;justify-content:center;
  background:var(--bg-input);border:1px solid var(--border);
  color:var(--text-muted);border-radius:var(--radius);cursor:pointer;
  font-size:15px;font-weight:var(--fw-medium);
  transition:border-color .15s, color .15s, background-color .15s;
}
.theme-btn:hover{border-color:var(--border-hover);color:var(--text);}

/* ── Input Section ───────────────────────────────────────────────── */
.input-section{margin-bottom:28px;}
.input-label{
  font-size:1rem;font-weight:var(--fw-bold);margin-bottom:8px;
  display:block;text-transform:uppercase;letter-spacing:.4px;
}
.url-input{
  width:100%;padding:14px 16px;
  background:var(--bg-input);color:var(--text);
  border:1px solid var(--border);border-radius:var(--radius);
  font-family:var(--font-mono);font-size:14px;
  font-weight:var(--fw-normal);
  outline:none;transition:border-color .15s;
}
.url-input:focus{border-color:var(--accent);}
.url-input::placeholder{color:var(--text-dim);}

.controls{display:flex;align-items:center;gap:14px;margin-top:14px;flex-wrap:wrap;}

.analyze-btn{
  padding:9px 28px;background:var(--accent);color:#fff;border:none;
  border-radius:var(--radius);font-weight:var(--fw-medium);
  font-size:14.5px;cursor:pointer;transition:background .15s;
  margin-left:auto;
}
.analyze-btn:hover{background:var(--accent-hover);}
.analyze-btn:disabled{opacity:.45;cursor:not-allowed;}

.hint-text{font-size:13px;color:var(--text-dim);font-weight:var(--fw-normal);}

/* ── Pipeline Timeline ───────────────────────────────────────────── */
#pipeline{display:none;margin-bottom:24px;}
.pipeline-box{
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:22px 24px;
  box-shadow:var(--shadow-card);
}
.pl-header{
  font-weight:var(--fw-bold);font-size:1rem;margin-bottom:14px;
  letter-spacing:.2px;text-transform:uppercase;
}

.pl-steps{display:flex;flex-direction:column;gap:0;position:relative;}

.pl-step{
  display:flex;align-items:center;gap:12px;
  padding:9px 0;font-size:14.5px;color:var(--text-dim);
  position:relative;font-weight:var(--fw-normal);
  padding-left:30px;
  transition:color .4s ease, font-weight .2s ease;
}
.pl-step::before{
  content:"";position:absolute;left:9px;top:0;bottom:0;
  width:2px;background:var(--border);
  transition:background .5s ease;
}
.pl-step:first-child::before{top:50%;}
.pl-step:last-child::before{bottom:50%;}
.pl-step::after{
  content:"";position:absolute;left:4px;top:50%;
  transform:translateY(-50%);width:12px;height:12px;
  border-radius:50%;border:2px solid var(--border);
  background:var(--bg-card);z-index:1;
  transition:border-color .5s ease, background .5s ease, box-shadow .5s ease;
}

/* Running */
.pl-step.running{color:var(--text);font-weight:var(--fw-medium);}
.pl-step.running::after{
  border:2px solid transparent;
  background:
    radial-gradient(circle, var(--accent) 30%, transparent 55%) no-repeat center/100% 100%,
    conic-gradient(from 0deg, transparent 0%, var(--accent) 40%, transparent 70%);
  background-origin:border-box;background-clip:padding-box, border-box;
  animation:node-spin 1.2s linear infinite, node-pulse 2s ease-in-out infinite;
  box-shadow:0 0 12px rgba(75,141,248,.3);
}
.pl-step.running::before{background:linear-gradient(to bottom, var(--text-muted) 0%, var(--accent) 40%, var(--border) 100%);}

@keyframes node-spin{
  from{transform:translateY(-50%) rotate(0deg);}
  to{transform:translateY(-50%) rotate(360deg);}
}
@keyframes node-pulse{
  0%,100%{box-shadow:0 0 8px rgba(75,141,248,.2);}
  50%{box-shadow:0 0 18px rgba(75,141,248,.45);}
}

/* Complete */
.pl-step.complete{color:var(--text);}
.pl-step.complete::after{border-color:var(--text-muted);background:var(--text-muted);animation:none;box-shadow:none;}
.pl-step.complete::before{background:var(--text-muted);}

/* Skipped */
.pl-step.skipped{color:var(--text-dim);}
.pl-step.skipped::after{border-color:var(--text-dim);background:transparent;}

.pl-label{flex:1;transition:color .4s ease;}
.pl-elapsed{
  font-size:12px;color:var(--text-dim);font-family:var(--font-mono);
  min-width:54px;text-align:right;font-weight:var(--fw-normal);
}

/* Progress bar */
.progress-group{margin-top:16px;display:flex;flex-direction:column;gap:10px;}
.progress-row{display:flex;align-items:center;gap:12px;}
.progress-label{font-size:13px;color:var(--text-muted);min-width:64px;font-weight:var(--fw-medium);}
.progress-track{flex:1;height:6px;background:var(--bg-input);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;transition:width .3s ease;width:0%;background:var(--accent);}
.progress-pct{font-size:12.5px;color:var(--text-dim);min-width:34px;text-align:right;font-family:var(--font-mono);}

/* Attempt badge */
.attempt-badge{
  font-size:11px;color:var(--yellow);background:var(--yellow-bg);
  border:1px solid rgba(240,184,22,.3);border-radius:4px;
  padding:1px 7px;font-family:var(--font-mono);font-weight:var(--fw-medium);
  margin-left:8px;
}

/* ── Timestamp bar ───────────────────────────────────────────────── */
.ts-bar{
  display:none;font-size:13.5px;color:var(--text-dim);
  justify-content:center;gap:24px;margin-bottom:20px;
  font-family:var(--font-mono);font-weight:var(--fw-normal);
}
.ts-bar .ts-detail{display:none;}
.ts-bar.finished .ts-detail{display:inline;}

/* ── Result Banner ───────────────────────────────────────────────── */
.result-banner{
  border-radius:var(--radius-lg);padding:24px 28px;margin-bottom:20px;
  display:none;box-shadow:var(--shadow-card);
}
.result-banner.SUCCESS{background:var(--green-bg);border:1px solid var(--green);}
.result-banner.FAILED{background:var(--red-bg);border:1px solid var(--red);}

.result-title{
  font-size:0.82rem;text-transform:uppercase;letter-spacing:1.5px;
  color:var(--text-muted);margin-bottom:10px;font-weight:var(--fw-bold);
}
.result-action{font-size:1.8rem;font-weight:var(--fw-bold);margin-bottom:6px;letter-spacing:.5px;}
.result-banner.SUCCESS .result-action{color:var(--green);}
.result-banner.FAILED .result-action{color:var(--red);}
.result-explain{font-size:15.5px;color:var(--text);line-height:1.6;margin-bottom:12px;font-weight:var(--fw-normal);}
.result-meta{font-size:14.5px;color:var(--text-dim);font-weight:var(--fw-normal);}

/* ── Sections ────────────────────────────────────────────────────── */
.section{
  display:none;background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius-lg);margin-bottom:20px;
  box-shadow:var(--shadow-card);
}
.section-head{
  padding:16px 24px;font-weight:var(--fw-bold);font-size:1rem;
  border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;
  letter-spacing:.3px;text-transform:uppercase;
}
.section-body{padding:20px 24px;}

/* ── Row pairs ───────────────────────────────────────────────────── */
.row{
  display:flex;justify-content:space-between;align-items:baseline;
  padding:7px 0;font-size:15.5px;gap:12px;
  border-bottom:1px solid var(--border);
}
.row:last-child{border-bottom:none;}
.row-label{color:var(--text-muted);font-weight:var(--fw-normal);flex-shrink:0;}
.row-value{font-weight:var(--fw-semi);text-align:right;word-break:break-all;font-family:var(--font-mono);font-size:14px;}
.row-value.plain{font-family:var(--font-sans);font-size:15.5px;font-weight:var(--fw-semi);}

/* Sub-label */
.sub-label{
  font-size:13.5px;font-weight:var(--fw-bold);
  color:var(--text-muted);text-transform:uppercase;letter-spacing:.6px;
  margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border);
}
.sub-label:first-child{margin-top:0;}

/* Code block */
.code-block{
  background:var(--bg-input);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px 14px;
  font-family:var(--font-mono);font-size:13px;
  color:var(--text);white-space:pre-wrap;word-break:break-all;
  line-height:1.6;margin-top:8px;
}

/* Helper text */
.helper-text{
  font-size:14.5px;color:var(--text-dim);margin-bottom:12px;
  line-height:1.6;font-weight:var(--fw-normal);
}

/* Status badges */
.badge{
  display:inline-block;font-size:11px;font-weight:var(--fw-bold);
  padding:2px 10px;border-radius:10px;text-transform:uppercase;letter-spacing:.5px;
}
.badge.success{background:var(--green-bg);color:var(--green);}
.badge.failed{background:var(--red-bg);color:var(--red);}
.badge.warn{background:var(--yellow-bg);color:var(--yellow);}

/* Indicator tags */
.indicator-tag{
  display:inline-block;background:var(--green-bg);color:var(--green);
  border:1px solid rgba(45,210,104,.3);border-radius:4px;
  font-size:12px;font-family:var(--font-mono);padding:2px 8px;
  margin:2px 3px;font-weight:var(--fw-medium);
}

/* Report markdown */
.report-body{
  font-size:15px;line-height:1.75;color:var(--text);
  font-weight:var(--fw-normal);
}
.report-body h2{
  font-size:1.1rem;font-weight:var(--fw-bold);margin:20px 0 8px;
  padding-bottom:6px;border-bottom:1px solid var(--border);
  color:var(--text);letter-spacing:.2px;
}
.report-body h2:first-child{margin-top:0;}
.report-body h3{
  font-size:0.95rem;font-weight:var(--fw-semi);
  margin:14px 0 6px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.4px;
}
.report-body p{margin-bottom:8px;}
.report-body p:last-child{margin-bottom:0;}
.report-body ul{margin:6px 0 10px 18px;}
.report-body li{margin-bottom:4px;}
.report-body strong{font-weight:var(--fw-semi);color:var(--text);}
.report-body em{color:var(--text-dim);font-style:italic;}
.report-body code{
  background:var(--bg-input);border:1px solid var(--border);
  border-radius:4px;padding:1px 6px;
  font-family:var(--font-mono);font-size:12.5px;color:var(--accent);
}
.report-body hr{border:none;border-top:1px solid var(--border);margin:16px 0;}

/* ── Exploitation Guide ──────────────────────────────────────────── */
.guide-banner{
  display:none;background:var(--bg-card);
  border:2px solid var(--red);border-radius:var(--radius-lg);
  margin-bottom:20px;box-shadow:0 0 24px rgba(240,82,82,.15);overflow:hidden;
}
.guide-banner-head{
  background:var(--red-bg);padding:18px 24px;
  display:flex;align-items:center;gap:12px;
  border-bottom:1px solid rgba(240,82,82,.3);
}
.guide-banner-tag{
  font-family:var(--font-mono);font-size:11px;font-weight:var(--fw-bold);
  letter-spacing:1.5px;color:var(--red);border:1px solid var(--red);
  padding:3px 8px;border-radius:3px;flex-shrink:0;line-height:1.4;
}
.guide-banner-title{
  font-size:1.1rem;font-weight:var(--fw-bold);color:var(--red);letter-spacing:.5px;
}
.guide-banner-sub{font-size:13px;color:var(--text-muted);margin-top:2px;}
.guide-open-btn{
  margin-left:auto;padding:8px 20px;background:var(--red);color:#fff;
  border:none;border-radius:var(--radius);cursor:pointer;
  font-size:13.5px;font-weight:var(--fw-semi);
  transition:background .15s;white-space:nowrap;
}
.guide-open-btn:hover{background:#c73e3e;}
.guide-body{padding:20px 24px;display:flex;flex-direction:column;gap:20px;}

/* Token box */
.token-box{
  background:var(--bg-input);border:1px solid var(--red);
  border-radius:var(--radius);padding:14px 16px;
}
.token-box-label{
  font-size:11px;font-weight:var(--fw-bold);text-transform:uppercase;
  letter-spacing:.8px;color:var(--red);margin-bottom:8px;display:flex;align-items:center;gap:8px;
}
.token-val{
  font-family:var(--font-mono);font-size:12px;color:var(--text);
  word-break:break-all;line-height:1.6;
}
.copy-btn{
  margin-left:auto;padding:3px 10px;background:transparent;
  border:1px solid var(--border);border-radius:4px;
  color:var(--text-dim);font-size:11px;cursor:pointer;
  transition:border-color .15s, color .15s;white-space:nowrap;
}
.copy-btn:hover{border-color:var(--accent);color:var(--accent);}

/* Step-by-step guide */
.guide-steps{display:flex;flex-direction:column;gap:12px;}
.guide-step{
  display:flex;gap:14px;align-items:flex-start;
  padding:14px 16px;background:var(--bg-input);border-radius:var(--radius);
  border:1px solid var(--border);
}
.guide-step-num{
  width:26px;height:26px;border-radius:50%;
  background:var(--accent);color:#fff;
  font-size:13px;font-weight:var(--fw-bold);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.guide-step-content{flex:1;}
.guide-step-title{font-size:14.5px;font-weight:var(--fw-semi);margin-bottom:4px;}
.guide-step-desc{font-size:13.5px;color:var(--text-muted);line-height:1.6;}
.guide-step-code{
  margin-top:8px;background:var(--bg-card);border:1px solid var(--border);
  border-radius:4px;padding:8px 12px;
  font-family:var(--font-mono);font-size:12px;color:var(--accent);
  white-space:pre-wrap;word-break:break-all;
}

/* What can attacker do */
.impact-list{display:flex;flex-direction:column;gap:8px;}
.impact-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;background:var(--red-bg);
  border:1px solid rgba(240,82,82,.2);border-radius:var(--radius);
  font-size:14px;color:var(--text);
}
.impact-icon{font-size:14px;flex-shrink:0;color:var(--red);font-weight:700;font-family:var(--font-mono);}

/* ── Responsive ──────────────────────────────────────────────────── */
@media(max-width:600px){
  .container{padding:14px;}
  .controls{flex-direction:column;align-items:stretch;}
  .analyze-btn{margin-left:0;}
}
</style>
</head>
<body>
<div class="container">

  <!-- ── Header ──────────────────────────────────────────────────── -->
  <div class="header">
    <div class="header-title">HackyMocchi</div>
    <div class="header-subtitle">Autonomous Pentest Agent</div>
    <button class="theme-btn" id="theme-btn" onclick="toggleTheme()" title="Toggle light/dark theme">&#9788;</button>
  </div>

  <!-- ── Input ───────────────────────────────────────────────────── -->
  <div class="input-section">
    <label class="input-label" for="target-url">Target URL</label>
    <input
      id="target-url"
      class="url-input"
      type="url"
      placeholder="http://localhost:3000"
      autocomplete="off"
      spellcheck="false"
    />

    <!-- 고급 옵션: 세션 쿠키 + 커스텀 헤더 -->
    <div style="margin-top:10px;">
      <button
        onclick="toggleAdvanced()"
        id="adv-toggle-btn"
        style="background:none;border:1px solid var(--border);color:var(--text-muted);
               padding:4px 12px;border-radius:6px;cursor:pointer;font-size:13px;">
        Options
      </button>
    </div>
    <div id="adv-panel" style="display:none;margin-top:10px;padding:14px;
         background:var(--bg-input);border:1px solid var(--border);border-radius:8px;">

      <!-- 자동 로그인 섹션 -->
      <div style="margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--border);">
        <div style="font-size:12px;color:var(--accent);font-weight:600;margin-bottom:8px;letter-spacing:.3px;">
          Auto Login
        </div>
        <div style="display:flex;gap:8px;margin-bottom:6px;">
          <div style="flex:1;">
            <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:3px;">Username / Email</label>
            <input
              id="login-username"
              style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);
                     border-radius:6px;color:var(--text);font-family:var(--font-mono);font-size:12px;box-sizing:border-box;"
              type="text"
              placeholder="your_username"
              autocomplete="off"
              spellcheck="false"
            />
          </div>
          <div style="flex:1;">
            <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:3px;">Password</label>
            <input
              id="login-password"
              style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);
                     border-radius:6px;color:var(--text);font-family:var(--font-mono);font-size:12px;box-sizing:border-box;"
              type="password"
              placeholder="your_password"
              autocomplete="off"
            />
          </div>
        </div>
        <div style="font-size:11px;color:var(--text-dim);">
          입력한 계정으로 자동 로그인 후 세션 쿠키를 획득합니다. 쿠키 만료 문제가 없습니다.
        </div>
      </div>

      <!-- 수동 쿠키 섹션 -->
      <div style="margin-bottom:10px;">
        <div style="font-size:12px;color:var(--text-muted);font-weight:600;margin-bottom:8px;letter-spacing:.3px;">
          Manual Session Cookie
        </div>
        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:3px;">
          Session Cookie
          <span style="color:var(--text-dim);font-weight:400;">(F12 → Application → Cookies)</span>
        </label>
        <input
          id="session-cookie"
          style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);
                 border-radius:6px;color:var(--text);font-family:var(--font-mono);font-size:12px;"
          type="text"
          placeholder="HackThisSite=abc123; session=xyz"
          autocomplete="off"
          spellcheck="false"
        />
      </div>
      <div>
        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:3px;">
          Custom Headers
          <span style="color:var(--text-dim);font-weight:400;">(JSON 형식)</span>
        </label>
        <input
          id="custom-headers"
          style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);
                 border-radius:6px;color:var(--text);font-family:var(--font-mono);font-size:12px;"
          type="text"
          placeholder='{"Authorization":"Bearer TOKEN"}'
          autocomplete="off"
          spellcheck="false"
        />
      </div>
    </div>

    <div class="controls">
      <span class="hint-text">허가된 시스템에서만 사용하세요</span>
      <button id="btn-analyze" class="analyze-btn" onclick="startAnalysis()">Analyze</button>
    </div>
  </div>

  <!-- ── Pipeline ────────────────────────────────────────────────── -->
  <div id="pipeline">
    <div class="pipeline-box">
      <div class="pl-header">Analysis Pipeline</div>
      <div class="pl-steps" id="pl-steps"></div>
      <div class="progress-group">
        <div class="progress-row">
          <span class="progress-label">Overall</span>
          <div class="progress-track"><div class="progress-fill" id="prog-overall"></div></div>
          <span class="progress-pct" id="prog-pct">0%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Timestamp bar ───────────────────────────────────────────── -->
  <div class="ts-bar" id="ts-bar">
    <span class="ts-detail" id="ts-start"></span>
    <span id="ts-elapsed"></span>
    <span class="ts-detail" id="ts-finish"></span>
  </div>

  <!-- ── Result Banner ───────────────────────────────────────────── -->
  <div class="result-banner" id="result-banner">
    <div class="result-title">Pentest Result</div>
    <div class="result-action" id="result-action"></div>
    <div class="result-explain" id="result-explain"></div>
    <div class="result-meta" id="result-meta"></div>
  </div>

  <!-- ── Exploitation Guide ──────────────────────────────────────── -->
  <div class="guide-banner" id="guide-banner">
    <div class="guide-banner-head">
      <div class="guide-banner-tag">VULN</div>
      <div>
        <div class="guide-banner-title" id="guide-title">취약점 발견</div>
        <div class="guide-banner-sub" id="guide-sub">발견된 취약점을 직접 재현하는 방법을 단계별로 설명합니다</div>
      </div>
      <button class="guide-open-btn" id="guide-open-btn" onclick="openTarget()">사이트 열기 &nearr;</button>
    </div>
    <div class="guide-body" id="guide-body"></div>
  </div>

  <!-- ── Recon Results ───────────────────────────────────────────── -->
  <div id="sec-recon" class="section">
    <div class="section-head">Reconnaissance</div>
    <div class="section-body" id="body-recon"></div>
  </div>

  <!-- ── Knowledge Retrieval ─────────────────────────────────────── -->
  <div id="sec-retrieve" class="section">
    <div class="section-head">Knowledge Retrieval</div>
    <div class="section-body" id="body-retrieve"></div>
  </div>

  <!-- ── Generated Payload ───────────────────────────────────────── -->
  <div id="sec-payload" class="section">
    <div class="section-head">Generated Payload</div>
    <div class="section-body" id="body-payload"></div>
  </div>

  <!-- ── Exploit Result ──────────────────────────────────────────── -->
  <div id="sec-exploit" class="section">
    <div class="section-head">Exploit Result</div>
    <div class="section-body" id="body-exploit"></div>
  </div>

  <!-- ── Final Report ────────────────────────────────────────────── -->
  <div id="sec-report" class="section">
    <div class="section-head">Final Report</div>
    <div class="section-body" id="body-report"></div>
  </div>

  <!-- ── PDF Export Button ──────────────────────────────────────── -->
  <div id="pdf-bar" style="display:none;margin-bottom:32px;">
    <button id="btn-pdf" onclick="downloadPdf()" style="
      width:100%;padding:14px;
      background:#1565C0;color:#fff;border:none;border-radius:6px;
      font-family:var(--font-mono);font-size:12px;font-weight:700;
      letter-spacing:1px;cursor:pointer;
    ">EXPORT PDF REPORT</button>
  </div>

</div>

<script>
/* ═══════════════════════════════════════════════════════════════════
   GLOBALS
═══════════════════════════════════════════════════════════════════ */
var analysisRunning = false;
var _lastReportState = null;  // stores exploit_result data for PDF export
var _lastReconState  = null;  // stores recon_result data for PDF export
var stepTimers = {};
var startedAt = null;
var elapsedInterval = null;
var currentAttempt = 0;
var guideTargetUrl = '';

var STEP_LABELS = [
  'Reconnaissance',
  'Knowledge Retrieval',
  'Payload Generation',
  'Attack Execution',
  'Report Generation'
];

var STEP_WEIGHTS = [10, 20, 20, 20, 30]; // weights for overall progress

/* ═══════════════════════════════════════════════════════════════════
   THEME
═══════════════════════════════════════════════════════════════════ */
function toggleTheme() {
  var t = document.documentElement.getAttribute('data-theme');
  var isLight = (t === 'light');
  document.documentElement.setAttribute('data-theme', isLight ? '' : 'light');
  document.getElementById('theme-btn').innerHTML = isLight ? '&#9788;' : '&#9789;';
}

/* ═══════════════════════════════════════════════════════════════════
   HELPERS
═══════════════════════════════════════════════════════════════════ */
function escapeHtml(s) {
  if (!s) return '';
  var d = document.createElement('div');
  d.appendChild(document.createTextNode(String(s)));
  return d.innerHTML;
}

function fmtElapsed(sec) {
  if (sec < 0.1) return '<0.1s';
  if (sec < 60) return sec.toFixed(1) + 's';
  return Math.floor(sec / 60) + 'm ' + Math.floor(sec % 60) + 's';
}

function fmt24h(date) {
  var h = date.getHours(), m = date.getMinutes(), s = date.getSeconds();
  return (h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
}

/* Simple markdown → HTML (subset) */
function markdownToHtml(md) {
  if (!md) return '';
  var html = escapeHtml(md);
  // headings
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  // bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // italic / emphasis
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // hr
  html = html.replace(/^---$/gm, '<hr>');
  // bullet lists
  html = html.replace(/^(\s*[-*+] .+)(\n\s*[-*+] .+)*/gm, function(block) {
    var items = block.split('\n').filter(function(l){return l.trim();});
    return '<ul>' + items.map(function(l){
      return '<li>' + l.replace(/^\s*[-*+] /, '') + '</li>';
    }).join('') + '</ul>';
  });
  // numbered lists
  html = html.replace(/^(\s*\d+\. .+)(\n\s*\d+\. .+)*/gm, function(block) {
    var items = block.split('\n').filter(function(l){return l.trim();});
    return '<ol>' + items.map(function(l){
      return '<li>' + l.replace(/^\s*\d+\. /, '') + '</li>';
    }).join('') + '</ol>';
  });
  // paragraphs — split on double newlines
  var parts = html.split(/\n{2,}/);
  html = parts.map(function(p) {
    p = p.trim();
    if (!p) return '';
    if (/^<(h[23]|ul|ol|hr)/.test(p)) return p;
    return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
  }).join('');
  return html;
}

/* ═══════════════════════════════════════════════════════════════════
   RESET UI
═══════════════════════════════════════════════════════════════════ */
function resetUI() {
  document.getElementById('pipeline').style.display = 'none';
  document.getElementById('pl-steps').innerHTML = '';
  document.getElementById('prog-overall').style.width = '0%';
  document.getElementById('prog-pct').textContent = '0%';
  document.getElementById('ts-bar').style.display = 'none';

  var banner = document.getElementById('result-banner');
  banner.style.display = 'none';
  banner.className = 'result-banner';

  document.getElementById('guide-banner').style.display = 'none';
  document.getElementById('guide-body').innerHTML = '';
  guideTargetUrl = '';

  ['sec-recon','sec-retrieve','sec-payload','sec-exploit','sec-report'].forEach(function(id) {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById('pdf-bar').style.display = 'none';
  ['body-recon','body-retrieve','body-payload','body-exploit','body-report'].forEach(function(id) {
    document.getElementById(id).innerHTML = '';
  });

  _lastReportState = null;
  _lastReconState  = null;

  Object.keys(stepTimers).forEach(function(k) {
    if (stepTimers[k]) clearInterval(stepTimers[k]);
  });
  stepTimers = {};
  currentAttempt = 0;

  if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
}

/* ═══════════════════════════════════════════════════════════════════
   START ANALYSIS
═══════════════════════════════════════════════════════════════════ */
function toggleAdvanced() {
  var panel = document.getElementById('adv-panel');
  var btn = document.getElementById('adv-toggle-btn');
  var isHidden = panel.style.display === 'none';
  panel.style.display = isHidden ? 'block' : 'none';
  btn.style.borderColor = isHidden ? 'var(--accent)' : 'var(--border)';
  btn.style.color = isHidden ? 'var(--accent)' : 'var(--text-muted)';
}

function startAnalysis() {
  var url = document.getElementById('target-url').value.trim();
  if (!url || analysisRunning) return;
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'http://' + url;
    document.getElementById('target-url').value = url;
  }

  // 자동 로그인 / 세션 쿠키 / 커스텀 헤더 수집
  var loginUsername = (document.getElementById('login-username').value || '').trim();
  var loginPassword = (document.getElementById('login-password').value || '').trim();
  var sessionCookie = (document.getElementById('session-cookie').value || '').trim();
  var customHeadersRaw = (document.getElementById('custom-headers').value || '').trim();
  var customHeaders = {};
  if (customHeadersRaw) {
    try { customHeaders = JSON.parse(customHeadersRaw); } catch(e) {}
  }

  analysisRunning = true;
  document.getElementById('btn-analyze').disabled = true;
  resetUI();

  startedAt = new Date();
  var tsBar = document.getElementById('ts-bar');
  tsBar.style.display = 'flex';
  tsBar.classList.remove('finished');
  document.getElementById('ts-start').textContent = 'Started: ' + fmt24h(startedAt);
  document.getElementById('ts-elapsed').textContent = 'Elapsed: 0s';
  document.getElementById('ts-finish').textContent = '';
  elapsedInterval = setInterval(function() {
    var elapsed = (Date.now() - startedAt.getTime()) / 1000;
    document.getElementById('ts-elapsed').textContent = 'Elapsed: ' + fmtElapsed(elapsed);
  }, 500);

  fetch('/api/analyze', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      target_url: url,
      session_cookie: sessionCookie || null,
      custom_headers: Object.keys(customHeaders).length > 0 ? customHeaders : null,
      username: loginUsername || null,
      password: loginPassword || null
    })
  }).then(function(response) {
    var reader = response.body.getReader();
    var decoder = new TextDecoder();
    var buffer = '';

    function read() {
      reader.read().then(function(result) {
        if (result.done) { finishAnalysis(); return; }
        buffer += decoder.decode(result.value, {stream: true});
        var lines = buffer.split('\n');
        buffer = lines.pop();

        var eventType = '', dataStr = '';
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i];
          if (line.indexOf('event: ') === 0) {
            eventType = line.substring(7).trim();
          } else if (line.indexOf('data: ') === 0) {
            dataStr = line.substring(6);
            if (eventType && dataStr) {
              try {
                handleEvent(eventType, JSON.parse(dataStr));
              } catch(e) {
                console.error('[HM] Parse error:', e, dataStr.substring(0, 100));
              }
            }
            eventType = ''; dataStr = '';
          }
        }
        read();
      }).catch(function(err) {
        console.error('Stream error:', err);
        finishAnalysis();
      });
    }
    read();
  }).catch(function(err) {
    console.error('Fetch error:', err);
    alert('연결 오류: ' + err.message);
    finishAnalysis();
  });
}

function finishAnalysis() {
  analysisRunning = false;
  document.getElementById('btn-analyze').disabled = false;
  if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
  Object.keys(stepTimers).forEach(function(k) {
    if (stepTimers[k]) clearInterval(stepTimers[k]);
  });
  var now = new Date();
  if (startedAt) {
    document.getElementById('ts-elapsed').textContent = 'Elapsed: ' + fmtElapsed((now - startedAt) / 1000);
  }
  document.getElementById('ts-finish').textContent = 'Finished: ' + fmt24h(now);
  document.getElementById('ts-bar').classList.add('finished');
}

/* ═══════════════════════════════════════════════════════════════════
   EVENT HANDLER
═══════════════════════════════════════════════════════════════════ */
function handleEvent(type, data) {
  if (type === 'pipeline_init') initPipeline(data);
  else if (type === 'step_update') updateStep(data);
  else if (type === 'stage') handleStage(data.stage, data.data);
  else if (type === 'done') { renderResult(data); finishAnalysis(); }
  else if (type === 'error') {
    alert('오류 발생: ' + (data.message || '알 수 없는 오류'));
    finishAnalysis();
  }
}

/* ═══════════════════════════════════════════════════════════════════
   PIPELINE
═══════════════════════════════════════════════════════════════════ */
function initPipeline(data) {
  document.getElementById('pipeline').style.display = 'block';
  var container = document.getElementById('pl-steps');
  container.innerHTML = '';

  STEP_LABELS.forEach(function(label, i) {
    var div = document.createElement('div');
    div.className = 'pl-step pending';
    div.id = 'step-' + i;
    div.innerHTML = '<span class="pl-label">' + escapeHtml(label) + '</span>'
      + '<span class="pl-elapsed" id="step-el-' + i + '"></span>';
    container.appendChild(div);
  });
}

function updateStep(data) {
  var idx = data.index;
  var el = document.getElementById('step-' + idx);
  if (!el) return;

  el.className = 'pl-step ' + data.status;
  var elEl = document.getElementById('step-el-' + idx);

  if (data.status === 'running') {
    var start = Date.now();
    stepTimers[idx] = setInterval(function() {
      elEl.textContent = fmtElapsed((Date.now() - start) / 1000);
    }, 500);
    updateProgress(idx);
  } else if (data.status === 'complete') {
    if (stepTimers[idx]) { clearInterval(stepTimers[idx]); delete stepTimers[idx]; }
    updateProgress(idx + 1);
  }
}

function updateProgress(completedSteps) {
  var total = STEP_WEIGHTS.reduce(function(a, b) { return a + b; }, 0);
  var done = 0;
  for (var i = 0; i < completedSteps && i < STEP_WEIGHTS.length; i++) {
    done += STEP_WEIGHTS[i];
  }
  var pct = Math.min(Math.round(done / total * 100), 100);
  document.getElementById('prog-overall').style.width = pct + '%';
  document.getElementById('prog-pct').textContent = pct + '%';
}

/* ═══════════════════════════════════════════════════════════════════
   STAGE RENDERERS
═══════════════════════════════════════════════════════════════════ */
function handleStage(stage, data) {
  if (stage === 'login_result') renderLogin(data);
  else if (stage === 'recon_result') { renderRecon(data); _lastReconState = data; }
  else if (stage === 'retrieve_result') renderRetrieve(data);
  else if (stage === 'generate_result') renderPayload(data);
  else if (stage === 'exploit_result') { renderExploit(data); _lastReportState = data; }
  else if (stage === 'report_result') renderReport(data);
}

function renderLogin(d) {
  // 파이프라인 스텝 라벨 중 "Login" 스텝 아래에 결과 표시
  var loginStep = document.querySelector('.step-label');
  // login_result 전용 배너를 pipeline 위에 삽입
  var banner = document.getElementById('login-result-banner');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'login-result-banner';
    banner.style.cssText = 'margin:10px 0;padding:10px 14px;border-radius:8px;font-size:13px;font-family:var(--font-mono);';
    var pipeline = document.getElementById('pipeline');
    if (pipeline) pipeline.parentNode.insertBefore(banner, pipeline);
  }
  if (d.success) {
    banner.style.background = 'rgba(80,200,120,0.12)';
    banner.style.border = '1px solid rgba(80,200,120,0.4)';
    banner.style.color = '#50c878';
    banner.innerHTML = '<span style="font-family:var(--font-mono);font-size:11px;font-weight:700;letter-spacing:1px;margin-right:10px;border:1px solid currentColor;padding:2px 6px;border-radius:2px;">LOGIN OK</span>' + (d.message || '세션 쿠키 획득 완료').replace('로그인 성공 ✅ 쿠키 획득: ', '').split(';')[0];
  } else {
    banner.style.background = 'rgba(255,100,100,0.10)';
    banner.style.border = '1px solid rgba(255,100,100,0.3)';
    banner.style.color = '#ff6464';
    banner.innerHTML = '<span style="font-family:var(--font-mono);font-size:11px;font-weight:700;letter-spacing:1px;margin-right:10px;border:1px solid currentColor;padding:2px 6px;border-radius:2px;">LOGIN FAIL</span>' + (d.message || '아이디/비밀번호를 확인하세요');
  }
}

function renderRecon(d) {
  var sec = document.getElementById('sec-recon');
  var body = document.getElementById('body-recon');
  sec.style.display = 'block';
  body.innerHTML =
    row('Target IP', d.ip || 'Unknown') +
    row('Server', d.server || 'Unknown') +
    row('Detected Tech', d.tech || 'Unknown');
}

function renderRetrieve(d) {
  var sec = document.getElementById('sec-retrieve');
  var body = document.getElementById('body-retrieve');
  sec.style.display = 'block';
  var docText = d.doc_count > 0
    ? '<span class="badge success">' + d.doc_count + ' docs found</span>'
    : '<span class="badge warn">No docs found</span>';
  body.innerHTML =
    '<div class="row"><span class="row-label">Knowledge Docs</span><span class="row-value plain">' + docText + '</span></div>' +
    row('Context Size', d.context_length + ' chars');
}

function renderPayload(d) {
  var sec = document.getElementById('sec-payload');
  var body = document.getElementById('body-payload');
  sec.style.display = 'block';

  currentAttempt = d.attempt || 1;

  var attemptBadge = '<span class="attempt-badge">Attempt #' + currentAttempt + '</span>';
  var postDataStr = (d.post_data && Object.keys(d.post_data).length > 0)
    ? JSON.stringify(d.post_data, null, 2)
    : 'None';

  var html = '<div class="sub-label" style="margin-top:0">Attack Request ' + attemptBadge + '</div>';
  html += row('Method', d.method || 'GET');
  html += '<div class="row"><span class="row-label" style="flex-shrink:0;min-width:80px;">URL</span><span class="row-value">' + escapeHtml(d.url) + '</span></div>';
  if (postDataStr !== 'None') {
    html += '<div class="sub-label">POST Data</div>';
    html += '<div class="code-block">' + escapeHtml(postDataStr) + '</div>';
  }
  if (d.explanation) {
    html += '<div class="sub-label">AI Reasoning</div>';
    html += '<p style="font-size:14.5px;color:var(--text-muted);line-height:1.7;">' + escapeHtml(d.explanation) + '</p>';
  }
  body.innerHTML = html;
}

function renderExploit(d) {
  var sec = document.getElementById('sec-exploit');
  var body = document.getElementById('body-exploit');
  sec.style.display = 'block';

  var statusBadge = d.is_success
    ? '<span class="badge success">SUCCESS</span>'
    : '<span class="badge failed">FAILED</span>';
  var codeText = d.status_code != null ? String(d.status_code) : 'N/A';

  var html = '';
  html += '<div class="row"><span class="row-label">Result</span><span class="row-value plain">' + statusBadge + '</span></div>';
  html += row('Attempt', '#' + (d.attempt || 1));
  html += row('HTTP Status', codeText);
  if (d.feedback) html += row('Feedback', d.feedback);
  if (d.indicators_found && d.indicators_found.length > 0) {
    html += '<div class="sub-label">Success Indicators Found</div>';
    html += '<div>' + d.indicators_found.map(function(ind) {
      return '<span class="indicator-tag">' + escapeHtml(ind) + '</span>';
    }).join('') + '</div>';
  }
  if (d.captured_email) html += row('Compromised Account', d.captured_email);
  if (d.captured_role)  html += row('Role', d.captured_role);

  // JWT 토큰 — Exploit 섹션에 직접 표시 (복사 버튼 포함)
  if (d.jwt_token) {
    html += '<div class="sub-label">탈취된 JWT 토큰</div>';
    html += '<div style="position:relative;">';
    html += '<div class="code-block" id="exploit-jwt-val" style="font-size:11px;word-break:break-all;padding-right:60px;">' + escapeHtml(d.jwt_token) + '</div>';
    html += '<button class="copy-btn" style="position:absolute;top:8px;right:8px;" onclick="copyExploitJwt()">복사</button>';
    html += '</div>';
    html += '<div class="helper-text" style="margin-top:6px;font-size:13px;color:var(--yellow);">';
    html += '→ F12 콘솔에서 아래 명령 실행 후 새로고침하면 관리자로 로그인됩니다';
    html += '</div>';
    html += '<div class="code-block" id="exploit-ls-cmd" style="font-size:12px;margin-top:4px;position:relative;padding-right:60px;">';
    html += escapeHtml('localStorage.setItem("token", "' + d.jwt_token + '")');
    html += '<button class="copy-btn" style="position:absolute;top:8px;right:8px;" onclick="copyLsCmd()">복사</button>';
    html += '</div>';
  }

  body.innerHTML = html;

  // 공격 성공 시 Exploitation Guide 표시
  if (d.is_success) renderGuide(d);
}

function renderGuide(d) {
  var banner = document.getElementById('guide-banner');
  var body   = document.getElementById('guide-body');
  banner.style.display = 'block';
  guideTargetUrl = d.target_url || '';

  // 공격 유형 판별
  // 1순위: jwt_token이 추출됨 → Auth Bypass (로그인 탈취)
  // 2순위: POST 로그인 공격이고 'token'/'authentication' 지표 발견 → Auth Bypass (토큰 미추출)
  // 3순위: 페이로드/URL로 XSS/LFI/IDOR 판별
  var attackType;
  var exp  = (d.attack_data && JSON.stringify(d.attack_data)) || '';
  var url  = d.attack_url || '';
  var inds = d.indicators_found || [];
  var hasTokenIndicator = inds.indexOf('token') !== -1 || inds.indexOf('authentication') !== -1;
  var isLoginPost = d.attack_method === 'POST' && (url.indexOf('login') !== -1 || url.indexOf('Login') !== -1);

  if (d.jwt_token) {
    attackType = 'Auth Bypass';
  } else if (hasTokenIndicator && isLoginPost) {
    attackType = 'Auth Bypass';
  } else if (url.indexOf('robots.txt') !== -1 || url.indexOf('.htpasswd') !== -1 || url.indexOf('.env') !== -1) {
    attackType = 'Recon';
  } else if (url.indexOf('missions/basic') !== -1) {
    attackType = 'CTF Mission';
  } else if (url.indexOf('/feed.gtl') !== -1 || url.indexOf('/snippets.gtl') !== -1 || inds.indexOf('_feed(') !== -1 || inds.indexOf('_snippet(') !== -1) {
    attackType = 'XSSI';
  } else if (exp.indexOf('<script') !== -1 || exp.indexOf('onerror') !== -1 || url.indexOf('search?q=') !== -1 || url.indexOf('search/?q=') !== -1) {
    attackType = 'XSS';
  } else if (url.indexOf('passwd') !== -1 || url.indexOf('../') !== -1 || url.indexOf('..%2F') !== -1) {
    attackType = 'LFI';
  } else if (url.indexOf('Users') !== -1 || url.indexOf('Feedbacks') !== -1) {
    attackType = 'IDOR';
  } else {
    attackType = 'SQL Injection';
  }

  var titleMap = {
    'Auth Bypass':   'SQLi Auth Bypass — JWT 토큰 획득',
    'XSSI':          'XSSI — 교차 출처 데이터 노출',
    'XSS':           'Reflected XSS — 스크립트 실행 확인',
    'LFI':           'LFI / Path Traversal — 서버 파일 읽기',
    'IDOR':          'IDOR — 비인가 데이터 접근',
    'SQL Injection': 'SQL Injection — 취약점 확인',
    'Recon':         'Information Disclosure — 민감 경로 노출',
    'CTF Mission':   'Sensitive Data Exposure — 인증 정보 노출',
  };
  document.getElementById('guide-title').textContent = titleMap[attackType] || '취약점 확인됨';

  var baseUrl = (d.target_url || '').split('#')[0].replace(/\/$/, '');
  var subMap = {
    'Auth Bypass':   '탈취한 JWT 토큰으로 관리자 계정에 직접 접근하는 방법입니다.',
    'XSSI':          '스크립트 포함으로 민감 데이터를 교차 출처에서 읽어오는 시나리오입니다.',
    'XSS':           'XSS 페이로드가 실행되는 URL에 접속하여 취약점을 재현합니다.',
    'LFI':           '경로 탐색 취약점으로 서버 내부 파일을 읽는 과정입니다.',
    'IDOR':          'ID 값 조작으로 타 사용자 데이터에 접근하는 과정입니다.',
    'Recon':         '노출된 경로와 파일을 통해 다음 공격 벡터를 파악합니다.',
    'CTF Mission':   '도구가 발견한 데이터를 기반으로 미션을 통과하는 과정입니다.',
  };
  document.getElementById('guide-sub').textContent = subMap[attackType] || '발견된 취약점을 재현하는 방법입니다.';

  var html = '';

  // Step-by-step 가이드
  var steps = buildGuideSteps(attackType, baseUrl, d);
  html += '<div class="sub-label" style="margin-top:0;">재현 방법</div>';
  html += '<div class="guide-steps">';
  steps.forEach(function(s, i) {
    html += '<div class="guide-step">';
    html += '<div class="guide-step-num">' + (i + 1) + '</div>';
    html += '<div class="guide-step-content">';
    html += '<div class="guide-step-title">' + escapeHtml(s.title) + '</div>';
    html += '<div class="guide-step-desc" style="white-space:pre-line;">' + escapeHtml(s.desc) + '</div>';
    if (s.code) {
      html += '<div style="position:relative;">';
      html += '<div class="guide-step-code" id="gstep-code-' + i + '">' + escapeHtml(s.code) + '</div>';
      html += '<button class="copy-btn" style="position:absolute;top:6px;right:6px;" '
            + 'onclick="copyStepCode(' + i + ')">복사</button>';
      html += '</div>';
    }
    html += '</div></div>';
  });
  html += '</div>';

  // 공격자가 할 수 있는 것
  var impacts = buildImpacts(attackType);
  html += '<div class="sub-label">Impact</div>';
  html += '<div class="impact-list">';
  impacts.forEach(function(imp) {
    html += '<div class="impact-item"><span class="impact-icon">' + imp.icon + '</span>' + escapeHtml(imp.text) + '</div>';
  });
  html += '</div>';

  // curl 재현 명령어
  html += '<div class="sub-label">Reproduce (curl)</div>';
  var curlCmd = buildCurl(d);
  html += '<div style="position:relative;">';
  html += '<div class="code-block" id="curl-cmd">' + escapeHtml(curlCmd) + '</div>';
  html += '<button class="copy-btn" style="position:absolute;top:8px;right:8px;" onclick="copyCurl()">복사</button>';
  html += '</div>';

  body.innerHTML = html;
}

function buildGuideSteps(attackType, baseUrl, d) {
  // ── Auth Bypass (JWT 토큰 탈취 후 브라우저 로그인) ─────────────────
  if (attackType === 'Auth Bypass') {
    var hasToken = !!d.jwt_token;
    var lsCmd = hasToken
      ? 'localStorage.setItem("token", "' + d.jwt_token + '")'
      : null;

    // 토큰 주입 단계 (jwt_token 있으면 바로 명령어, 없으면 curl로 확인 안내)
    var tokenStep = hasToken
      ? {
          title: 'Console에 아래 명령어 붙여넣고 Enter',
          desc: '아래 명령어를 복사한 뒤 Console 입력창에 붙여넣기(Ctrl+V)하고 Enter를 누르세요.\n실행 후 "undefined"가 출력되면 토큰 주입 성공입니다.',
          code: lsCmd
        }
      : {
          title: '응답에서 JWT 토큰 값을 직접 복사',
          desc: '아래 curl 명령어를 터미널에서 실행하세요.\n응답 JSON에서 "token": "eyJ..." 부분의 값 전체를 복사합니다.\n그런 다음 Console에 아래 형식으로 입력하세요:',
          code: 'localStorage.setItem("token", "여기에_응답의_token_값_붙여넣기")'
        };

    return [
      {
        title: '대상 사이트 열기',
        desc: '아래 버튼 또는 주소창에 대상 URL을 입력해 사이트를 새 탭에서 엽니다.',
        code: baseUrl
      },
      {
        title: '개발자 도구 열기 — F12',
        desc: 'Chrome / Edge: F12 키, 또는 우클릭 → "검사(Inspect)"\nFirefox: F12 또는 Ctrl+Shift+I\n개발자 도구 패널이 화면 오른쪽 또는 아래에 나타납니다.',
        code: ''
      },
      {
        title: '"Console" 탭 클릭',
        desc: '개발자 도구 상단 탭 목록에서 "Console"을 선택하세요.\n(Elements → Console → Sources → Network 순으로 있습니다)',
        code: ''
      },
      tokenStep,
      {
        title: '페이지 새로고침 — F5',
        desc: 'F5 또는 Ctrl+R을 눌러 페이지를 새로고침하세요.\n브라우저가 localStorage의 JWT 토큰을 읽어 관리자로 자동 인증합니다.',
        code: ''
      },
      {
        title: '관리자 패널 접근',
        desc: '주소창에 아래 경로를 직접 입력하고 Enter를 누르세요.\n관리자 메뉴가 표시되면 침투 성공입니다.',
        code: baseUrl + '/#/administration'
      },
      {
        title: '전체 사용자 정보 열람',
        desc: '아래 URL로 이동하면 가입된 모든 계정의\n이메일·비밀번호 해시·주소·결제 정보를 조회할 수 있습니다.',
        code: 'GET ' + baseUrl + '/api/Users/'
      }
    ];

  // ── XSS ───────────────────────────────────────────────────────────
  } else if (attackType === 'XSSI') {
    return [
      {
        title: '취약 엔드포인트 직접 확인',
        desc: '아래 URL에 접속해 JavaScript 함수 형태(_feed/_snippet)로 데이터가 반환되는지 확인합니다.',
        code: d.attack_url || ''
      },
      {
        title: '공격자 페이지에서 script include',
        desc: '다른 도메인 페이지에서 아래 스크립트 태그로 포함해도 데이터가 로드되면 XSSI 재현입니다.',
        code: '<script src="' + (d.attack_url || '') + '"><\\/script>'
      }
    ];

  } else if (attackType === 'XSS') {
    return [
      {
        title: '대상 사이트 열기',
        desc: '아래 버튼을 눌러 대상 사이트를 새 탭에서 엽니다.',
        code: baseUrl
      },
      {
        title: 'XSS 취약 URL 접속',
        desc: '아래 URL에 직접 접속하면 삽입된 스크립트가 브라우저에서 실행됩니다.\nalert 팝업이 뜨면 스크립트 실행 성공입니다.',
        code: d.attack_url || ''
      },
      {
        title: '세션 쿠키 탈취 확인',
        desc: 'Console에서 아래 명령을 실행하면 피해자 쿠키(세션 ID 등)를 읽을 수 있습니다.',
        code: 'console.log(document.cookie)'
      }
    ];

  // ── LFI ───────────────────────────────────────────────────────────
  } else if (attackType === 'LFI') {
    return [
      {
        title: '취약 URL 직접 접속',
        desc: '아래 URL에 접속하면 서버의 /etc/passwd 파일 내용이 응답으로 반환됩니다.',
        code: d.attack_url || ''
      },
      {
        title: '시스템 계정 정보 확인',
        desc: '응답 본문에 "root:x:0:0:" 형태의 시스템 계정 목록이 표시되면\n경로 탈출(Path Traversal) 취약점이 실제로 존재하는 것입니다.',
        code: ''
      }
    ];

  // ── IDOR ──────────────────────────────────────────────────────────
  } else if (attackType === 'IDOR') {
    return [
      {
        title: '대상 사이트 열기',
        desc: '대상 사이트를 새 탭으로 엽니다.',
        code: baseUrl
      },
      {
        title: 'IDOR 취약 엔드포인트 접근',
        desc: '아래 URL로 직접 접속하면 인증 없이 다른 사용자 데이터를 조회합니다.',
        code: d.attack_url || ''
      },
      {
        title: 'ID 값을 바꾸며 다른 계정 탐색',
        desc: 'URL 끝의 숫자(1, 2, 3, ...)를 바꾸면 다른 사용자의 정보도 열람됩니다.',
        code: ''
      }
    ];

  // ── Recon ─────────────────────────────────────────────────────────
  } else if (attackType === 'Recon') {
    var foundPaths = (d.indicators_found || []).filter(function(i) { return i.startsWith('/'); });
    var pathsText = foundPaths.length > 0 ? foundPaths.join(', ') : '숨겨진 경로 포함 가능';
    return [
      {
        title: '발견된 파일 직접 접근',
        desc: '아래 URL로 직접 접속하면 노출된 파일/정보를 확인할 수 있습니다.',
        code: d.attack_url || ''
      },
      {
        title: '발견된 민감 경로 탐색',
        desc: 'robots.txt에 노출된 Disallow 경로를 직접 방문하세요: ' + pathsText,
        code: ''
      },
      {
        title: '다음 공격 경로 설정',
        desc: '발견된 경로(/admin, /private 등)를 대상으로 인증 우회 또는 접근 제어 취약점을 추가로 테스트하세요.',
        code: ''
      }
    ];

  // ── CTF Mission ───────────────────────────────────────────────────
  } else if (attackType === 'CTF Mission') {
    var indicators = d.indicators_found || [];
    var attackBase = (d.attack_url || '').replace(/\/+$/, '');
    var steps = [];

    // hidden input 파싱
    var hiddenInputs = indicators.filter(function(s) { return s.indexOf('[HIDDEN INPUT]') === 0; });
    // JS 변수 파싱
    var jsVars = indicators.filter(function(s) { return s.indexOf('[JS VAR]') === 0 || s.indexOf('[JS COMPARE]') === 0; });

    if (hiddenInputs.length > 0) {
      hiddenInputs.forEach(function(hint) {
        var nameM = hint.match(/name=([^\s]+)/);
        var valM  = hint.match(/value=([^\s]+)/);
        var fieldName  = nameM  ? nameM[1]  : '';
        var fieldValue = valM   ? valM[1]   : '';

        if (fieldName === 'file' && fieldValue) {
          // Mission 3 류 — 파일에 패스워드 저장
          var fileUrl = attackBase + '/' + fieldValue;
          steps.push({
            title: '취약점 확인: 패스워드 파일 경로가 소스에 노출됨',
            desc: '도구가 미션 페이지 소스에서 아래 hidden 필드를 발견했습니다.\n\n    <input type="hidden" name="' + fieldName + '" value="' + fieldValue + '">\n\n서버는 이메일 발송 대신 패스워드를 파일(' + fieldValue + ')에 저장해뒀고,\n그 파일명이 HTML에 그대로 노출되어 있습니다.',
            code: null
          });
          steps.push({
            title: '패스워드 파일 직접 접속',
            desc: '아래 URL을 브라우저 주소창에 입력하고 Enter를 누르세요.\n서버가 해당 파일에 대한 접근 제어를 하지 않아 패스워드가 그대로 표시됩니다.',
            code: fileUrl
          });
          steps.push({
            title: '패스워드 복사 후 미션 폼에 제출',
            desc: '파일에서 보이는 패스워드 문자열을 복사한 뒤,\n미션 페이지 Password 입력란에 붙여넣고 Submit 버튼을 클릭하세요.',
            code: attackBase + '/'
          });

        } else if (fieldValue && fieldName.match(/^(pass|password|passwd|solution|answer|key)$/i)) {
          // Mission 1 류 — hidden 필드에 패스워드 직접 삽입
          steps.push({
            title: '취약점 확인: 패스워드가 HTML에 평문 노출',
            desc: '페이지 소스에 아래 hidden 필드가 있습니다.\n\n    <input type="hidden" name="' + fieldName + '" value="' + fieldValue + '">\n\n패스워드(' + fieldValue + ')가 브라우저로 전송되는 HTML에 그대로 포함되어 있습니다.',
            code: null
          });
          steps.push({
            title: '패스워드를 폼에 입력하고 제출',
            desc: '발견된 패스워드: ' + fieldValue + '\n\n미션 페이지 Password 입력란에 위 값을 입력하고 Submit을 누르세요.',
            code: attackBase + '/'
          });

        } else if (fieldValue) {
          // 기타 hidden 필드
          steps.push({
            title: 'hidden 필드 발견: ' + fieldName + ' = ' + fieldValue,
            desc: '페이지 소스에서 숨겨진 필드를 발견했습니다. 이 값을 미션 폼에 시도해보세요.',
            code: attackBase + '/'
          });
        }
      });

    } else if (jsVars.length > 0) {
      jsVars.forEach(function(hint) {
        // "[JS VAR] pass='secretpassword'"
        var valM = hint.match(/'([^']+)'/);
        var val = valM ? valM[1] : '';
        steps.push({
          title: '취약점 확인: JS 소스에 패스워드 평문 노출',
          desc: '미션 페이지의 JavaScript에서 아래 코드가 발견됐습니다.\n\n    ' + hint.replace('[JS VAR] ', 'var ').replace('[JS COMPARE] ', '// compare: ') + '\n\n클라이언트 측에서 패스워드를 검증하기 때문에 소스만 보면 바로 알 수 있습니다.',
          code: null
        });
        if (val) {
          steps.push({
            title: '패스워드를 폼에 입력하고 제출',
            desc: '발견된 패스워드: ' + val + '\n\n미션 페이지 Password 입력란에 위 값을 입력하고 Submit을 누르세요.',
            code: attackBase + '/'
          });
        }
      });

    } else {
      // 세션 OK지만 특정 데이터 없음 — 수동 확인 안내
      steps = [
        {
          title: '미션 페이지 접속 후 소스 확인',
          desc: '아래 URL을 브라우저에서 열고 Ctrl+U로 페이지 소스를 여세요.\n그 다음 Ctrl+F를 눌러 hidden, password, pass, var pass 등을 검색합니다.',
          code: attackBase + '/'
        },
        {
          title: 'Network 탭에서 요청 파악',
          desc: 'F12 → Network 탭을 열고 미션 폼을 Submit하면\n어떤 파라미터로 요청이 가는지 확인할 수 있습니다.',
          code: null
        }
      ];
    }

    return steps;

  // ── Default ───────────────────────────────────────────────────────
  } else {
    return [
      {
        title: '대상 사이트 열기',
        desc: '대상 사이트를 새 탭으로 엽니다.',
        code: baseUrl
      },
      {
        title: '공격 URL 접속',
        desc: '아래 URL에 직접 접속해 응답을 확인하세요.',
        code: d.attack_url || ''
      }
    ];
  }
}

function buildImpacts(attackType) {
  var m = '–';
  if (attackType === 'Auth Bypass') {
    return [
      {icon: m, text: '관리자 계정 무단 로그인 — 패스워드 없이 관리자 권한 획득'},
      {icon: m, text: '전체 사용자 PII 열람 가능 (이메일, 패스워드 해시, 주소)'},
      {icon: m, text: '주문·결제 데이터 접근 / 관리자 패널 상품·유저 데이터 조작'},
    ];
  } else if (attackType === 'XSS') {
    return [
      {icon: m, text: '피해자 브라우저에서 임의 JS 실행'},
      {icon: m, text: '세션 쿠키 탈취 후 계정 하이재킹 가능'},
      {icon: m, text: '키로거 삽입 — 입력값(패스워드, 카드번호 등) 실시간 수집'},
    ];
  } else if (attackType === 'XSSI') {
    return [
      {icon: m, text: '교차 출처 script include로 민감 데이터 유출 가능'},
      {icon: m, text: '사용자 인증 상태를 악용한 계정/스니펫 정보 탈취 가능'},
    ];
  } else if (attackType === 'LFI') {
    return [
      {icon: m, text: '/etc/passwd 등 시스템 파일 읽기'},
      {icon: m, text: 'SSH 개인키, .env, 설정파일, 소스코드 취득 가능'},
    ];
  } else if (attackType === 'IDOR') {
    return [
      {icon: m, text: '인증 없이 타 사용자 데이터 열람'},
      {icon: m, text: '타 사용자 주문/개인정보 수정 또는 삭제 가능'},
    ];
  } else if (attackType === 'Recon') {
    return [
      {icon: m, text: 'robots.txt를 통해 숨겨진 관리 경로(/admin 등) 파악'},
      {icon: m, text: '민감 파일(.htpasswd, .env) 위치 특정 — 추가 공격 진입점'},
    ];
  } else if (attackType === 'CTF Mission') {
    return [
      {icon: m, text: '페이지 소스에서 평문 패스워드 또는 파일 경로 노출'},
      {icon: m, text: 'hidden 필드, JS 변수, 서버 파일에 인증 정보가 평문 저장됨'},
    ];
  } else {
    return [
      {icon: m, text: '인증 우회 또는 민감 데이터 노출 취약점 확인됨'},
    ];
  }
}

function buildCurl(d) {
  if (d.attack_method === 'POST' && d.attack_data && Object.keys(d.attack_data).length > 0) {
    return 'curl -X POST "' + d.attack_url + '" \\\n'
      + '  -H "Content-Type: application/json" \\\n'
      + '  -d \'' + JSON.stringify(d.attack_data) + '\'';
  }
  return 'curl "' + d.attack_url + '"';
}

function copyStepCode(idx) {
  var el = document.getElementById('gstep-code-' + idx);
  if (el) navigator.clipboard.writeText(el.textContent.trim());
}

function copyToken() {
  var el = document.getElementById('jwt-token-val');
  if (el) navigator.clipboard.writeText(el.textContent);
}

function copyExploitJwt() {
  var el = document.getElementById('exploit-jwt-val');
  if (el) navigator.clipboard.writeText(el.textContent);
}

function copyLsCmd() {
  var el = document.getElementById('exploit-ls-cmd');
  if (el) {
    // 버튼 텍스트 제외하고 순수 명령어만 복사
    var text = el.childNodes[0] ? el.childNodes[0].textContent : el.textContent;
    navigator.clipboard.writeText(text.trim());
  }
}

function copyCurl() {
  var el = document.getElementById('curl-cmd');
  if (el) navigator.clipboard.writeText(el.textContent);
}

function openTarget() {
  if (guideTargetUrl) window.open(guideTargetUrl, '_blank');
}

function renderReport(d) {
  var sec = document.getElementById('sec-report');
  var body = document.getElementById('body-report');
  sec.style.display = 'block';
  body.innerHTML = '<div class="report-body">' + markdownToHtml(d.report) + '</div>';
  document.getElementById('pdf-bar').style.display = 'block';
}

function downloadPdf() {
  var btn = document.getElementById('btn-pdf');
  btn.textContent = 'GENERATING...';
  btn.disabled = true;

  // Merge recon + exploit data (exploit fields win on conflict)
  var payload = Object.assign({}, _lastReconState || {}, _lastReportState || {});

  // Map recon field names to what pdf_report.py expects
  if (!payload.target_ip  && payload.ip)   payload.target_ip   = payload.ip;
  if (!payload.detected_tech && payload.tech) payload.detected_tech = payload.tech;
  // Normalize attempt (singular) → attempts (plural)
  if (payload.attempt != null && payload.attempts == null) payload.attempts = payload.attempt;

  // Fallback: read target URL from input if missing
  if (!payload.target_url) {
    var urlEl = document.getElementById('target-url');
    if (urlEl) payload.target_url = urlEl.value || '';
  }

  fetch('/api/report/pdf', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  })
  .then(function(res) {
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return res.blob();
  })
  .then(function(blob) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    // filename: pentest_report_YYYYMMDD_HHMMSS.pdf
    var ts = new Date().toISOString().replace(/[-:T]/g,'').slice(0,15);
    a.download = 'pentest_report_' + ts + '.pdf';
    document.body.appendChild(a);
    a.click();
    setTimeout(function() { URL.revokeObjectURL(url); a.remove(); }, 2000);
  })
  .catch(function(e) { alert('PDF 생성 실패: ' + e.message); })
  .finally(function() {
    btn.textContent = 'PDF EXPORT';
    btn.disabled = false;
  });
}

function renderResult(d) {
  var banner = document.getElementById('result-banner');
  var decision = d.is_success ? 'SUCCESS' : 'FAILED';
  banner.className = 'result-banner ' + decision;
  banner.style.display = 'block';

  document.getElementById('result-action').textContent = decision;
  document.getElementById('result-explain').textContent = d.is_success
    ? '공격 성공: 대상 시스템에서 취약점이 발견되었습니다.'
    : '공격 실패: 현재 페이로드로는 취약점을 확인할 수 없습니다.';
  document.getElementById('result-meta').textContent =
    '시도 횟수: ' + d.attempts + '회  |  대상: ' + d.target_url +
    '  |  IP: ' + (d.target_ip || d.ip || 'Unknown');
}

/* ── Row helper ───────────────────────────────────────────────────── */
function row(label, value) {
  return '<div class="row"><span class="row-label">' + escapeHtml(label) + '</span>'
    + '<span class="row-value">' + escapeHtml(String(value)) + '</span></div>';
}
</script>
</body>
</html>
